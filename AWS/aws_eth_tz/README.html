<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>STM32H573I-DK aws_eth_tz</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="../../../_htmresc/mini-st_2020_raw.css" />
  <link rel="icon" type="image/x-icon" href="../../../_htmresc/favicon.png" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">STM32H573I-DK <em>aws_eth_tz</em></h1>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#keywords" id="toc-keywords"><span
class="toc-section-number">1</span> Keywords</a></li>
<li><a href="#directory-contents" id="toc-directory-contents"><span
class="toc-section-number">2</span> Directory contents</a></li>
<li><a href="#hardware-and-software-environment"
id="toc-hardware-and-software-environment"><span
class="toc-section-number">3</span> Hardware and Software
environment</a>
<ul>
<li><a href="#hardware-and-test-environment"
id="toc-hardware-and-test-environment"><span
class="toc-section-number">3.1</span> Hardware and test
environment</a></li>
<li><a href="#cloud-account-and-resources"
id="toc-cloud-account-and-resources"><span
class="toc-section-number">3.2</span> Cloud account and
resources</a></li>
<li><a href="#development-environment"
id="toc-development-environment"><span
class="toc-section-number">3.3</span> Development environment</a>
<ul>
<li><a href="#aws-tools" id="toc-aws-tools"><span
class="toc-section-number">3.3.1</span> AWS tools</a></li>
<li><a href="#st-platform-tools" id="toc-st-platform-tools"><span
class="toc-section-number">3.3.2</span> ST platform tools</a></li>
<li><a href="#other-tools" id="toc-other-tools"><span
class="toc-section-number">3.3.3</span> Other tools</a></li>
</ul></li>
<li><a href="#target-preparation" id="toc-target-preparation"><span
class="toc-section-number">3.4</span> Target preparation</a></li>
</ul></li>
<li><a href="#how-to-use-it" id="toc-how-to-use-it"><span
class="toc-section-number">4</span> How to use it?</a>
<ul>
<li><a href="#firmware-build-and-installation"
id="toc-firmware-build-and-installation"><span
class="toc-section-number">4.1</span> Firmware build and
installation</a></li>
<li><a href="#runtime-device-provisioning"
id="toc-runtime-device-provisioning"><span
class="toc-section-number">4.2</span> Runtime device
provisioning</a></li>
<li><a href="#registration-of-the-device-with-aws-iot-core"
id="toc-registration-of-the-device-with-aws-iot-core"><span
class="toc-section-number">4.3</span> Registration of the device with
AWS IoT Core</a></li>
<li><a href="#observation-of-mqtt-messages-on-the-aws-iot-core-console"
id="toc-observation-of-mqtt-messages-on-the-aws-iot-core-console"><span
class="toc-section-number">4.4</span> Observation of MQTT messages on
the AWS IoT Core Console</a></li>
<li><a href="#ota-firmware-update" id="toc-ota-firmware-update"><span
class="toc-section-number">4.5</span> OTA Firmware Update</a>
<ul>
<li><a href="#generate-a-code-signing-key"
id="toc-generate-a-code-signing-key"><span
class="toc-section-number">4.5.1</span> Generate a code signing
key</a></li>
<li><a href="#setup-ota-s3-bucket-service-role-and-policies-in-aws"
id="toc-setup-ota-s3-bucket-service-role-and-policies-in-aws"><span
class="toc-section-number">4.5.2</span> Setup OTA S3 bucket, Service
role and policies in AWS</a></li>
<li><a href="#create-a-code-signed-firmware-update-job"
id="toc-create-a-code-signed-firmware-update-job"><span
class="toc-section-number">4.5.3</span> Create a code signed firmware
update job</a></li>
<li><a href="#monitoring-and-verification-of-firmware-update"
id="toc-monitoring-and-verification-of-firmware-update"><span
class="toc-section-number">4.5.4</span> Monitoring and Verification of
firmware update</a></li>
</ul></li>
</ul></li>
<li><a href="#design-notes" id="toc-design-notes"><span
class="toc-section-number">5</span> Design notes</a>
<ul>
<li><a
href="#shared-resources-between-the-non-secure-partition-and-the-secure-partition"
id="toc-shared-resources-between-the-non-secure-partition-and-the-secure-partition"><span
class="toc-section-number">5.1</span> Shared resources between the
non-secure partition and the secure partition</a>
<ul>
<li><a href="#clocks" id="toc-clocks"><span
class="toc-section-number">5.1.1</span> Clocks</a></li>
<li><a href="#stlink-uart" id="toc-stlink-uart"><span
class="toc-section-number">5.1.2</span> STLINK UART</a></li>
</ul></li>
<li><a href="#freertos-heap-configuration"
id="toc-freertos-heap-configuration"><span
class="toc-section-number">5.2</span> FreeRTOS heap
configuration</a></li>
<li><a href="#mbedtls-configuration"
id="toc-mbedtls-configuration"><span
class="toc-section-number">5.3</span> MbedTLS configuration</a></li>
<li><a href="#ethernet-mac-address-definition"
id="toc-ethernet-mac-address-definition"><span
class="toc-section-number">5.4</span> Ethernet MAC address
definition</a></li>
<li><a href="#provisions-for-running-freertos-qualification-tests"
id="toc-provisions-for-running-freertos-qualification-tests"><span
class="toc-section-number">5.5</span> Provisions for running FreeRTOS
qualification tests</a></li>
<li><a href="#ide-project-settings" id="toc-ide-project-settings"><span
class="toc-section-number">5.6</span> IDE project settings</a></li>
</ul></li>
<li><a href="#troubleshooting" id="toc-troubleshooting"><span
class="toc-section-number">6</span> Troubleshooting</a>
<ul>
<li><a href="#windows-environment" id="toc-windows-environment"><span
class="toc-section-number">6.1</span> Windows environment</a>
<ul>
<li><a href="#device-provisioning" id="toc-device-provisioning"><span
class="toc-section-number">6.1.1</span> Device provisioning</a></li>
<li><a
href="#secure-manager-access-kit-scripts-for-trustzone-applications-sensitivity-to-the-path-environment-variable"
id="toc-secure-manager-access-kit-scripts-for-trustzone-applications-sensitivity-to-the-path-environment-variable"><span
class="toc-section-number">6.1.2</span> <em>Secure Manager Access
Kit</em> scripts for TrustZone applications: Sensitivity to the
<em>PATH</em> environment variable</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
<p>This application example is a port of the <a
href="https://www.freertos.org/STM32U5">FreeRTOS STM32U5 IoT Reference
Integration</a> to the STM32H573 Discovery kit, using ST <em>Secure
Manager</em> as the TrustZone <em>Secure Processing Environment</em> and
secure bootloader, with its pre-provisioned device unique identity.</p>
<p>In this project, the <em>Secure Manager</em> is configured to run the
user application in the <em>Non-Secure Processing Environment</em>,
leveraging the ARM PSA APIs (PSA Crypto, PSA Internal Storage, PSA
Firmware Update) implemented in the Secure Processing Environment for
TLS authentication, secure firmware update, and secure storage of user
data.</p>
<blockquote>
<p>The <em>Secure Manager</em> encrypted image (package reference:
<mark>X-CUBE-SEC-M-H5</mark>) must be downloaded from the <a
href="https://www.st.com/en/embedded-software/stm32trustee-sm.html">STM32TRUSTEE-SM</a>
web page and installed on the target prior to programming this
application example.</p>
<p>Please refer to the <a
href="https://wiki.st.com/stm32mcu/wiki/Security:Secure_Manager">Secure
Manager</a> documentation and <a
href="https://wiki.st.com/stm32mcu/wiki/Category:How_to_start_with_Secure_Manager_on_STM32H5">How
to start with Secure Manager on SM32H5</a> for more information.</p>
<p><mark>Important</mark> <strong>The <em>Secure Manager</em> binary and
its future updates is subject to export control and shall be handled
accordingly by the user, including in case it is transferred to the
device by an over-the-air firmware update procedure.</strong></p>
</blockquote>
<p>The application is composed of:</p>
<ul>
<li><p>A command line interpreter, used for:</p>
<ul>
<li>provisioning the device: Endpoint name and root CA certificate, code
signing key;</li>
<li>monitoring the runtime resources consumption (RTOS tasks and dynamic
memory).</li>
</ul></li>
<li><p>An MQTT client, connecting to AWS IoT Core over TLS with mutual
authentication based on a unique X.509 certificate provisioned at ST
manufacturing.</p></li>
<li><p>AWS agents, supporting the following AWS IoT Core services:</p>
<ul>
<li>Shadows</li>
<li>Device Defender</li>
<li>OTA update</li>
<li>Raw telemetry data reporting (consisting of network packets
statistics)</li>
</ul></li>
</ul>
<h1 data-number="1" id="keywords"><span
class="header-section-number">1</span> Keywords</h1>
<ul>
<li>FreeRTOS</li>
<li>AWS</li>
<li>OTA</li>
<li>Ethernet</li>
<li>ARM TrustZone for Cortex-M</li>
<li>ARM Platform Security Architecture (PSA)</li>
<li>Secure Manager</li>
<li>Device Unique Authentication</li>
</ul>
<h1 data-number="2" id="directory-contents"><span
class="header-section-number">2</span> Directory contents</h1>
<p>Files specific to the present project:</p>
<pre><code>aws_eth_tz
├── .extSettings                              STM32CubeMX extended configuration file
├── Binary
│   └── appli_enc_sign.bin                   Signed binary image ready to be installed by the STuROT firmware update
├── Images
│   ├── SM_Code_Image.xml
│   └── SM_Code_Image_bin.xml
├── Inc
│   ├── kvstore_config_plat.h
│   ├── main.h
│   ├── mbedtls_config_psa.h                  MbedTLS configuration, optimized for read-only footprint
│   ├── stm32h5xx_hal_conf.h
│   ├── stm32h5xx_it.h
│   └── tls_transport_config.h                Mapping of the PKI objects between the MbedTLS port and PSA
├── README.md
├── README.html
├── STM32CubeIDE
│   ├── Application
│   │   ├── Startup
│   │   │   └── startup_stm32h573iikxq.s
│   │   └── User
│   │       ├── syscalls.c
│   │       └── sysmem.c
│   ├── .cproject
│   ├── .project
│   ├── STM32H573I-DK_aws_eth_tz.launch
│   ├── STM32H573IIKXQ_FLASH.ld               Linker file, patched by the project pre-build command to match the STuROT memory mapping
│   └── postbuild.sh                          STM32CubeIDE project post-build command, which generates a signed binary image file to be installed by the STuROT firmware update
├── Src
│   ├── app_main.c                            Application entry point
│   ├── main.c
│   ├── mbedtls_entropy_alt_psa.c             MbedTLS entropy generator relying on the PSA random generation API
│   ├── stm32h5xx_hal_msp.c
│   ├── stm32h5xx_it.c
│   ├── system_stm32h5xx.c
│   └── tfm_ns_interface_freertos.c           PSA API dispatch interface, implementing thread protection and optional API logging
├── download.bat                              Application installation through the STuROT secure update mechanism
├── download.sh
├── env.sh
├── prebuild.sh                               STM32CubeIDE project pre-build command, which updates the linker file according to the STuROT memory mapping
└── STM32H573I-DK_aws_eth_tz.ioc              STM32CubeMX project configuration file</code></pre>
<p>Project-common files (common to all project variants and all
targets):<br />
The ‘-’ marks denote the sub-directories or files which are not used in
the present project.</p>
<pre><code>../Common/                                    Source files common to the ports of the FreeRTOS Reference Integration for
                                              STM32 (different targets, different connectivities, different boot and
                                              OTA firmware update mechanisms).
├── app
│   ├── auto_provisioning.c                   Reconstruct the device user certificate and store it in a PSA ITS object
│   ├── defender                              AWS Device Defender task
│   │   ├── defender_task.c
│   │   ├── metrics_collector.h
│   │   └── metrics_collector_lwip.c
│   ├── emu_sensor_publish.c                  Emulated sensor telemetry task, reporting network packet statistics
│   ├── env_sensor_publish.c            -
│   ├── motion_sensors_publish.c        -
│   ├── mqtt                                  AWS IoT Core MQTT task
│   │   ├── freertos_command_pool.c
│   │   ├── freertos_command_pool.h
│   │   ├── mqtt_agent_task.c
│   │   ├── mqtt_agent_task.h
│   │   └── subscription_manager.h
│   ├── ota                                   AWS IoT Core OTA Firmware Update task
│   │   └── ota_update_task.c
│   ├── pub_sub_test_task.c
│   ├── qualification_app_main.c
│   └── shadow_device_task.c                  AWS IoT Core Shadow task
├── boards
│   └── stm32u5_iot_board.c             -
├── cli                                       Embedded command line interface supporting terminal logging, and network
                                                 and PKI configuration.
│   ├── ReadMe.html
│   ├── ReadMe.md
│   ├── cli.h
│   ├── cli_conf.c
│   ├── cli_main.c
│   ├── cli_pki.c
│   ├── cli_prv.h
│   ├── cli_rngtest.c
│   ├── cli_uart_drv.c
│   ├── cli_utils.c
│   ├── logging.c
│   ├── logging.h
│   └── logging_levels.h
├── config                                    Middleware configuration files
│   ├── FreeRTOSConfig.h
│   ├── b_u585i_iot02a_conf.h           -
│   ├── core_http_config.h
│   ├── core_mqtt_agent_config.h
│   ├── core_mqtt_config.h
│   ├── defender_config.h
│   ├── hw_defs.h
│   ├── kvstore_config.h
│   ├── lwipopts.h
│   ├── mqtt_metrics.h
│   ├── ota_config.h
│   ├── shadow_config.h
│   ├── test_execution_config.h
│   ├── test_param_config.h
│   ├── tls_transport_lwip.h
│   └── unity_config.h
├── crypto                                   Cryptography application module supporting the embedded CLI PKI commands
                                                and the device authentication by MbedTLS.
│   ├── PkiObject.c
│   ├── PkiObjectPkcs11.c               -  Port to PKCS#11
│   ├── PkiObjectPsa.c                     Port PSA Crypto, PSA ITS and optionally PSA PS
│   ├── PkiObject_prv.h
│   ├── ReadMe.html
│   ├── ReadMe.md
│   ├── mbedtls_pk_pkcs11.c             -  MbedTLS integration of the PKCS#11 backend
│   ├── mbedtls_pk_psa.c                   MbedTLS integration of the PSA backend
│   ├── psa_util.c
│   └── psa_util.h
├── include
│   ├── PkiObject.h
│   ├── cmsis_os.h                      -
│   ├── mbedtls_error_utils.h
│   ├── mbedtls_freertos_port.h
│   ├── mbedtls_transport.h
│   └── sys_evt.h
├── kvstore                                 Permanent storage application module for the network configuration
│   ├── ReadMe.html
│   ├── ReadMe.md
│   ├── kvstore.c
│   ├── kvstore.h
│   ├── kvstore_cache.c                    Store cache in RAM
│   ├── kvstore_nv_littlefs.c           -  LittleFs backend
│   ├── kvstore_nv_psa_its.c               PSA ITS backend
│   └── kvstore_prv.h
├── net                                     TCP/IP socket porting application module
│   ├── eth                                 LwIP/Ethernet backend
│   │   ├── eth_dataplane.c
│   │   ├── eth_lwip.c
│   │   ├── eth_lwip.h
│   │   ├── eth_netconn.c
│   │   ├── eth_netconn.h
│   │   └── eth_prv.h
│   ├── lwip_port                           LwIP port
│   │   ├── include
│   │   │   ├── arch
│   │   │   │   ├── cc.h
│   │   │   │   ├── perf.h
│   │   │   │   └── sys_arch.h
│   │   │   └── lwipopts_freertos.h
│   │   └── src
│   │       └── sys_arch.c
│   ├── mbedtls_transport.c                 MbedTLS port to the net and crypto port
│   └── mxchip                           -  LwIP/Mx-Chip EMW3080 Wi-Fi backend over SPI
│       ├── mx_dataplane.c               -
│       ├── mx_ipc.c                     -
│       ├── mx_ipc.h                     -
│       ├── mx_lwip.c                    -
│       ├── mx_lwip.h                    -
│       ├── mx_netconn.c                 -
│       ├── mx_netconn.h                 -
│       └── mx_prv.h                     -
└── sys
    ├── interrupt_handlers.c
    ├── mbedtls_freertos_port.c
    └── newlibc_stubs.c</code></pre>
<h1 data-number="3" id="hardware-and-software-environment"><span
class="header-section-number">3</span> Hardware and Software
environment</h1>
<h2 data-number="3.1" id="hardware-and-test-environment"><span
class="header-section-number">3.1</span> Hardware and test
environment</h2>
<p>This example runs on STM32H573I-DK devices.</p>
<dl>
<dt><img src="../../../Documentation/STM32H573I-DK.png" /></dt>
<dd>
<p>Figure: Target connectivity overview</p>
</dd>
</dl>
<p>Equipment to be connected to the device. Refer to picture above to
locate the connectors.</p>
<ol type="1">
<li><p>Ethernet port<br />
For the user application to connect to Internet.<br />
Plug an RJ45 cable connected to and open IPv4 Internet connection. The
local network must provide a DHCP server.</p></li>
<li><p>USB-C STLINK port<br />
For supplying power to the target, programming and debugging over USB,
and as a serial terminal console and command-line interface.<br />
Connect to a USB port of the user computer installed with:</p></li>
</ol>
<ul>
<li>ST tools allowing programming and debugging (STM32CubeIDE,
STM32CubeProgrammer),</li>
<li>A terminal emulator.</li>
</ul>
<h2 data-number="3.2" id="cloud-account-and-resources"><span
class="header-section-number">3.2</span> Cloud account and
resources</h2>
<p>The user must have registered an AWS account with the appropriate
rights.</p>
<p>Follow your organization’s policy regarding configuring your access
to AWS with temporary or long term IAM credentials. If not such policy
exists, refer to the instructions on the <a
href="https://docs.aws.amazon.com/iot/latest/developerguide/setting-up.html">Set
up your AWS account</a> for details on your options.</p>
<h2 data-number="3.3" id="development-environment"><span
class="header-section-number">3.3</span> Development environment</h2>
<p>The tool versions compatible with this expansion package are
documented in the <a href="../../../Release_Notes.html">Release
Notes</a>.</p>
<p>The open-source tools should preferably be installed by a package
manager (such as <a href="https://scoop.sh">scoop</a> for Windows) to
easily manage the installed versions and benefit from homogeneous
execution paths. It is advised to double-check your <em>PATH</em>
environment variable and ensure that:</p>
<ul>
<li>Different versions of the tools are not active at the same
time;</li>
<li>C: is placed before /usr/bin when running .bat files</li>
</ul>
<h3 data-number="3.3.1" id="aws-tools"><span
class="header-section-number">3.3.1</span> AWS tools</h3>
<ul>
<li><p>The AWS CLI tool is used for most interactions between the user
and AWS:</p>
<ol type="1">
<li><p>Download AWS CLI for your platform from the <a
href="https://aws.amazon.com/cli">official website</a> or using your
preferred package manager.</p></li>
<li><p>Refer to the following guides for configuring AWS CLI depending
on how your AWS account is set up:</p>
<ul>
<li><a
href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-sso.html">Configuring
the AWS CLI to use AWS IAM Identity Center</a></li>
<li><a
href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-quickstart.html">Quick
configuration with aws configure</a></li>
</ul></li>
</ol></li>
<li><p>AWS CLI must have access to Internet in order to be used for the
provisioning, create OTA Update jobs, etc..<br />
Depending on your environment, HTTP proxy settings may have to be
defined.</p></li>
</ul>
<h3 data-number="3.3.2" id="st-platform-tools"><span
class="header-section-number">3.3.2</span> ST platform tools</h3>
<ul>
<li><p>The following tools must be installed for building the
application and programming the target.</p>
<ul>
<li><a
href="https://www.st.com/content/st_com/en/stm32cubeide.html">STM32CubeIDE</a></li>
<li><a
href="https://www.st.com/en/development-tools/stm32cubeprog.html">STM32CubeProgrammer</a>,
which must be installed in the default location
(<code>C:\Program Files\STMicroelectronics\STM32Cube\STM32CubeProgrammer</code>).</li>
</ul></li>
</ul>
<h3 data-number="3.3.3" id="other-tools"><span
class="header-section-number">3.3.3</span> Other tools</h3>
<ul>
<li><em>python3</em>, to
<ul>
<li>Install or remove the Secure Manager from the target</li>
<li>Build the TrustZone-enabled applications (used by the pre-build and
post-build scripts)</li>
<li>Use the provisioning helper scripts<br />
Must be seconded by the modules listed in
<em>&lt;env_dir&gt;tools/requirements.txt</em>, to be installed by<br />
<code>$ python3 -m pip install -r &lt;env_dir&gt;/tools/requirements.txt</code>.</li>
</ul></li>
<li><em>openssl</em>, to
<ul>
<li>Generate the code signing material required for launching OTA
firmware update</li>
</ul></li>
<li>(optional) <em>bash</em>, <em>awk</em>, to
<ul>
<li>Run the example scripts (for device enrollment, OTA, and easy
copy/paste of command lines) embedded in the present readme.</li>
</ul></li>
</ul>
<h2 data-number="3.4" id="target-preparation"><span
class="header-section-number">3.4</span> Target preparation</h2>
<ul>
<li><p>The Secure Manager must first be programmed on the target</p>
<ol type="1">
<li>Connect the target STLINK USB port to your computer</li>
<li>Download the X-CUBE-SEC-M-H5 package from <a
href="https://www.st.com/en/embedded-software/stm32trustee-sm.html">STM32TRUSTEE-SM</a>
and unzip its contents over your local environment</li>
<li>Call
<code>&lt;env_dir&gt;/Projects/STM32H573I-DK/ROT_Provisioning/SM/provisioning_auto.bat</code>
by double-clicking on the file in Windows Explorer.<br />
On Linux, use
<code>&lt;env_dir&gt;/Projects/STM32H573I-DK/ROT_Provisioning/SM/provisioning.sh</code>.</li>
</ol>
<p>Note: After usage, before installing a non-TrustZone application on
the same target, you will have to Uninstall the Secure Manager by
performing a full script regression:<br />
Call
<code>&lt;env_dir&gt;/Projects/STM32H573I-DK/ROT_Provisioning/DA/regression.bat</code>
by double-clicking on the file in Windows Explorer.<br />
On Linux, use
<code>&lt;env_dir&gt;/Projects/STM32H573I-DK/ROT_Provisioning/DA/regression.sh</code>.</p>
<p>See the Secure Manager documentation for more information.</p></li>
</ul>
<h1 data-number="4" id="how-to-use-it"><span
class="header-section-number">4</span> How to use it?</h1>
<p>The required steps to run the application example follow. Here is the
outline:</p>
<ul>
<li>Firmware build and installation</li>
<li>Runtime device provisioning</li>
<li>Registration of the device with AWS IoT Core</li>
<li>Observation of MQTT messages on the AWS IoT Core Console</li>
<li>(optional) OTA Firmware Update</li>
</ul>
<h2 data-number="4.1" id="firmware-build-and-installation"><span
class="header-section-number">4.1</span> Firmware build and
installation</h2>
<ol type="1">
<li><p>When installing your development environment on MS Windows,
substitute the expansion package installation path to a dedicated
Windows drive letter. This avoids possible issues with long paths.</p>
<p>For instance, create the <code>S:</code> virtual drive from the
Windows command line:</p>
<pre><code>C:\Users\johndoe&gt; subst S: C:\Users\johndoe\Downloads\STM32CubeExpansion_Cloud_AWS_H5_V&lt;package_version&gt;</code></pre>
<p>When installing your development environment on Linux, ensure that
the STM32CubeProgrammer bin directory is in your <em>PATH</em>
environment variable, and set the executable attribute of the installed
<em>.sh</em> scripts:</p>
<pre><code>$ export PATH=$PATH:&lt;your_install_path&gt;/STM32CubeProgrammer-2.14.0/bin
$ find &lt;env_dir&gt; -iname &quot;*.sh&quot; | xargs chmod a+x</code></pre></li>
<li><p>Open STM32CubeIDE. If prompted, create a fresh workspace for the
version of the X-CUBE-AWS-H5 expansion package you installed (you may
want to use <code>S:</code>, but the workspace location should not
matter).</p></li>
<li><p>Import the project from the <code>S:</code> subst drive in your
STM32CubeIDE workspace (<strong>File</strong>/<strong>Open Projects from
Filesystem</strong>/<strong>Import
source</strong>/<strong>Directory</strong> menu)</p></li>
<li><p>Build the project (right-click on the project in the STM32CubeIDE
Project Explorer pane, and select <strong>Build
Project</strong>)</p></li>
<li><p>Connect the target STLINK USB port to your computer</p></li>
<li><p>Load the binary into download slot of the target by clicking on
the file <code>download.bat</code> in the IDE project explorer, or in
Windows Explorer, or by launching
<code>&lt;project&gt;/download.sh</code>.</p></li>
<li><p>(optional) A debugger launch configuration is available
(right-click on the project in the STM32CubeIDE Project Explorer pane,
and select <strong>Debug As</strong>/<strong>Debug
Configurations</strong>/<strong>STM32 C/C++
Applications</strong>/STM32H573I-DK_aws_eth_tz).</p></li>
</ol>
<h2 data-number="4.2" id="runtime-device-provisioning"><span
class="header-section-number">4.2</span> Runtime device
provisioning</h2>
<ol type="1">
<li><p>Open the target board’s serial port with your favorite serial
terminal emulator. Some common options are TeraTerm, putty, screen,
minicom, and picocom.</p>
<p>Use the settings below.</p>
<table>
<caption>Table: Terminal settings</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Serial settings</th>
<th></th>
<th></th>
<th style="text-align: left;">Terminal settings</th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Baud rate</td>
<td>115200</td>
<td></td>
<td style="text-align: left;">New Line receive</td>
<td>Auto</td>
</tr>
<tr class="even">
<td style="text-align: left;">Data</td>
<td>8 bit</td>
<td></td>
<td style="text-align: left;">New line transmit</td>
<td>LF</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Parity</td>
<td>None</td>
<td></td>
<td style="text-align: left;"></td>
<td></td>
</tr>
<tr class="even">
<td style="text-align: left;">Stop</td>
<td>1 bit</td>
<td></td>
<td style="text-align: left;"></td>
<td></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Flow control</td>
<td>None</td>
<td></td>
<td style="text-align: left;"></td>
<td></td>
</tr>
</tbody>
</table></li>
<li><p>Verify that the embedded CLI is functional by typing
<code>help conf</code> in the terminal emulator. The following message
should be displayed:</p>
<pre><code>&gt; help conf
conf:
    Get/ Set/ Commit runtime configuration values
    Usage:
    conf get
        Outputs the value of all runtime config options supported by the system.

    conf get &lt;key&gt;
        Outputs the current value of a given runtime config item.

    conf set &lt;key&gt; &lt;value&gt;
        Set the value of a given runtime config item. This change is staged
        in volatile memory until a commit operation occurs.

    conf commit
        Commit staged config changes to nonvolatile memory.</code></pre>
<p>The provisioning method detailed below relies on the device unique
key and certificate which are provisionned by ST in the STM32H573 SoC at
manufacturing time.</p>
<p><mark>Variant</mark> In case the users prefer to stick to the same
method as used in the Non-TrustZone application examples, they
should:</p>
<ol type="a">
<li>Define the USE_CUSTOM_TLS_KEY compilation switch in the STM32CubeIDE
project (<strong>Properties</strong>/<strong>C/C++
Build</strong>/<strong>Settings</strong>/<strong>Tools
Settings</strong>/<strong>MCU GCC
Compiler</strong>/<strong>Preprocessor</strong>/<strong>Define
Symbols</strong>)</li>
<li>Follow the device runtime provisioning steps detailed in the <a
href="../aws_eth/Readme.html"><em>aws_eth</em></a> readme file.</li>
</ol>
<p>The <a href="../../STM32CubeProjectsList.html#tls-dua"><em>TLS with
Device Unique Authentication</em> section</a> of the ProjectList
document gives an overview of the possible device provisioning
options.</p>
<p>Otherwise, the thing name is automatically set to the value of the
certificate subject <em>Common Name</em>.</p>
<p>It can be checked by typing the following command in the terminal
emulator:</p>
<pre><code>&gt; conf get thing_name
thing_name=&quot;stm32h5xx-user-xxxxxxxxxxxxxxxxxxxx&quot;</code></pre>
<p>The device certificate may also be displayed:</p>
<pre><code>&gt; pki export cert
-----BEGIN CERTIFICATE-----
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
(...)
xxxxxxxxxxxx
-----END CERTIFICATE-----</code></pre></li>
<li><p>Set the AWS IoT Core MQTT endpoint for your AWS account and
region:</p>
<pre><code>&gt; conf set mqtt_endpoint xxxxxxxxxxxxxx-ats.iot.us-west-2.amazonaws.com
mqtt_endpoint=&quot;xxxxxxxxxxxxxx-ats.iot.us-west-2.amazonaws.com&quot;</code></pre>
<p>You can determine the endpoint for your AWS account</p>
<ul>
<li>either with this AWS CLI command:
<code>$ aws iot describe-endpoint --endpoint-type iot:Data-ATS</code></li>
<li>or on the <em>Settings</em> page of the AWS IoT Core web
console.</li>
</ul></li>
<li><p>Commit the staged configuration changes to non-volatile
memory.</p>
<pre><code>&gt; conf commit
Configuration saved to NVM.</code></pre></li>
<li><p>Import the certificate of the root CA of your endpoint</p>
<p>Copy/paste the contents of the <a
href="https://www.amazontrust.com/repository/AmazonRootCA3.pem">Amazon
Root CA 3 PEM file</a> on the terminal right after this command, and
type <em>enter</em>:</p>
<pre><code>&gt; pki import cert root_ca_cert
-----BEGIN CERTIFICATE-----
MIIBtjCCAVugAwIBAgITBmyf1XSXNmY/Owua2eiedgPySjAKBggqhkjOPQQDAjA5
MQswCQYDVQQGEwJVUzEPMA0GA1UEChMGQW1hem9uMRkwFwYDVQQDExBBbWF6b24g
Um9vdCBDQSAzMB4XDTE1MDUyNjAwMDAwMFoXDTQwMDUyNjAwMDAwMFowOTELMAkG
A1UEBhMCVVMxDzANBgNVBAoTBkFtYXpvbjEZMBcGA1UEAxMQQW1hem9uIFJvb3Qg
Q0EgMzBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABCmXp8ZBf8ANm+gBG1bG8lKl
ui2yEujSLtf6ycXYqm0fc4E7O5hrOXwzpcVOho6AF2hiRVd9RFgdszflZwjrZt6j
QjBAMA8GA1UdEwEB/wQFMAMBAf8wDgYDVR0PAQH/BAQDAgGGMB0GA1UdDgQWBBSr
ttvXBp43rDCGB5Fwx5zEGbF4wDAKBggqhkjOPQQDAgNJADBGAiEA4IWSoxe3jfkr
BqWTrBqYaGFy+uGh0PsceGCmQ5nFuMQCIQCcAu/xlJyzlvnrxir4tiz+OpAUFteM
YyRIHN8wfdVoOw==
-----END CERTIFICATE-----</code></pre>
<p>For verifying the import, type:</p>
<pre><code>&gt; pki export cert root_ca_cert
-----BEGIN CERTIFICATE-----
MIIBtjCCAVugAwIBAgITBmyf1XSXNmY/Owua2eiedgPySjAKBggqhkjOPQQDAjA5
MQswCQYDVQQGEwJVUzEPMA0GA1UEChMGQW1hem9uMRkwFwYDVQQDExBBbWF6b24g
Um9vdCBDQSAzMB4XDTE1MDUyNjAwMDAwMFoXDTQwMDUyNjAwMDAwMFowOTELMAkG
A1UEBhMCVVMxDzANBgNVBAoTBkFtYXpvbjEZMBcGA1UEAxMQQW1hem9uIFJvb3Qg
Q0EgMzBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABCmXp8ZBf8ANm+gBG1bG8lKl
ui2yEujSLtf6ycXYqm0fc4E7O5hrOXwzpcVOho6AF2hiRVd9RFgdszflZwjrZt6j
QjBAMA8GA1UdEwEB/wQFMAMBAf8wDgYDVR0PAQH/BAQDAgGGMB0GA1UdDgQWBBSr
ttvXBp43rDCGB5Fwx5zEGbF4wDAKBggqhkjOPQQDAgNJADBGAiEA4IWSoxe3jfkr
BqWTrBqYaGFy+uGh0PsceGCmQ5nFuMQCIQCcAu/xlJyzlvnrxir4tiz+OpAUFteM
YyRIHN8wfdVoOw==
-----END CERTIFICATE-----</code></pre>
<p>Note: Provisioning the <em>Amazon Root CA 3</em> (ECDSA-based)
instead of the more usual <em>Amazon Root CA 1</em> (RSA-based) is
mandatory. It allows to fully remove the RSA support from the TLS
library and reduce the read-only memory footprint of the
application.</p></li>
</ol>
<blockquote>
<p>Alternatively to the manual device provisioning steps detailed in the
present section, it is possible to call the following script after
having disconnected your terminal emulator from the serial
interface:</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> python3 ./tools/provision.py <span class="at">--cert-issuer</span> st</span></code></pre></div>
<p>Note: In the present application example, the Wi-Fi SSID and
credentials do not have to be set. See the <a
href="../../STM32CubeProjectsList.html#provisioning-script">script
documentation</a> section in the ProjectList document for details.</p>
</blockquote>
<h2 data-number="4.3"
id="registration-of-the-device-with-aws-iot-core"><span
class="header-section-number">4.3</span> Registration of the device with
AWS IoT Core</h2>
<p>Despite the <em>register-certificate-without-ca</em> method used in
<a href="../aws_eth/Readme.html"><em>aws_eth</em></a> application
example remains possible, one advantage of the STM32H573 device unique
authentication is that the pre-provisioned device certificate is signed
by an ST root CA which can be registered at AWS IoT Core, so that the
device certificate is validated and automatically registered at first
connection.</p>
<p>Follow the instructions at the AWS IoT Core Developer Guide to <a
href="https://docs.aws.amazon.com/iot/latest/developerguide/auto-register-device-cert.html">register
a client certificate when the client connects to AWS IoT just-in-time
registration (JITR)</a>:</p>
<ol type="1">
<li><p>Register the ST Device Unique Authentication user root CA <a
href="../../../Utilities/Certificates/st_ca_01_dua_user_certificate.pem">certificate</a>:</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> iot register-ca-certificate <span class="at">--ca-certificate</span> file://<span class="op">&lt;</span>env_dir<span class="op">&gt;</span>/Utilities/Certificates/st_ca_01_dua_user_certificate.pem <span class="dt">\</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">--certificate-mode</span> SNI_ONLY <span class="dt">\</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">--set-as-active</span> <span class="dt">\</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">--allow-auto-registration</span></span></code></pre></div>
<p>Note down the returned CA certificate ID. It is referred to as
<em>&lt;ca_cert_id&gt;</em> below.</p></li>
<li><p>Reset your device in order to force a new connection to AWS IoT
Core</p>
<p>By pushing the reset button, or by typing the following command in
the terminal emulator:</p>
<pre><code>&gt; reset
Resetting device.</code></pre>
<p>At this stage, the device is able to connect over TLS, but the MQTT
connection is rejected by the server because the certificate is not
activated and the device is not registered yet.</p></li>
<li><p>Retrieve the list of the certificates registered in just-in-time
mode, which are in <em>PENDING_ACTIVATION</em> state</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> iot list-certificates-by-ca <span class="at">--ca-certificate-id</span> <span class="op">&lt;</span>ca_cert_id<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">--query</span> <span class="st">&#39;certificates[?status==`PENDING_ACTIVATION`].certificateId|join(`, `, @)&#39;</span></span></code></pre></div>
<p>Note your device certificate ID. It is referred to as
<em>&lt;cert_id&gt;</em> below.</p></li>
<li><p>Retrieve the details of the device certificate</p>
<ul>
<li><p>Get the certificate ARN. It is referred to as
<em>&lt;cert_arn&gt;</em> below.</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> iot describe-certificate <span class="at">--certificate-id</span> <span class="op">&lt;</span>cert_id<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">--query</span> <span class="st">&#39;certificateDescription.certificateArn&#39;</span></span></code></pre></div></li>
<li><p>Get the certificate PEM payload and double-check that it
corresponds to the one displayed by the embedded CLI in the previous
steps.</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> iot describe-certificate <span class="at">--certificate-id</span> <span class="op">&lt;</span>cert_id<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">--query</span> <span class="st">&#39;certificateDescription.certificatePem&#39;</span></span></code></pre></div></li>
</ul></li>
<li><p>Activate the device certificate</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> iot update-certificate <span class="at">--certificate-id</span> <span class="op">&lt;</span>cert_id<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">--new-status</span> <span class="st">&quot;ACTIVE&quot;</span></span></code></pre></div></li>
<li><p>Create a policy if none exists</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> iot create-policy <span class="dt">\</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">--policy-name</span><span class="op">=</span><span class="st">&quot;AllowAllDev&quot;</span> <span class="dt">\</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">--policy-document</span><span class="op">=</span><span class="st">&quot;{ </span><span class="dt">\&quot;</span><span class="st">Version</span><span class="dt">\&quot;</span><span class="st">: </span><span class="dt">\&quot;</span><span class="st">2012-10-17</span><span class="dt">\&quot;</span><span class="st">, </span><span class="dt">\&quot;</span><span class="st">Statement</span><span class="dt">\&quot;</span><span class="st">: [{</span><span class="dt">\&quot;</span><span class="st">Effect</span><span class="dt">\&quot;</span><span class="st">: </span><span class="dt">\&quot;</span><span class="st">Allow</span><span class="dt">\&quot;</span><span class="st">, </span><span class="dt">\&quot;</span><span class="st">Action</span><span class="dt">\&quot;</span><span class="st">: </span><span class="dt">\&quot;</span><span class="st">iot:*</span><span class="dt">\&quot;</span><span class="st">, </span><span class="dt">\&quot;</span><span class="st">Resource</span><span class="dt">\&quot;</span><span class="st">: </span><span class="dt">\&quot;</span><span class="st">*</span><span class="dt">\&quot;</span><span class="st">}]}&quot;</span></span></code></pre></div>
<p><mark>Important</mark> This policy allows very broad access to AWS
IoT MQTT APIs. Use a more restrictive policy for any production
environments.</p></li>
<li><p>Attach a security policy to the certificate</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> iot attach-policy <span class="dt">\</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">--target</span> <span class="op">&lt;</span>cert_arn<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">--policy-name</span> AllowAllDev</span></code></pre></div></li>
<li><p>Create the thing</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> iot create-thing <span class="at">--thing-name</span> <span class="op">&lt;</span>thing_name<span class="op">&gt;</span></span></code></pre></div>
<p><mark>Important</mark> <code>&lt;thing_name&gt;</code> must be the
exact name that the application example extracts from the device
certificate. Any other value will be rejected by the server at MQTT
connection time.</p></li>
<li><p>Attach the certificate to the thing</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> iot attach-thing-principal <span class="dt">\</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">--principal</span> <span class="op">&lt;</span>cert_arn<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">--thing-name</span> <span class="op">&lt;</span>thing_name<span class="op">&gt;</span></span></code></pre></div></li>
</ol>
<p>Now that the device is registered and granted with IoT Core
permissions, it is allowed to connect to the IoT Core endpoint.</p>
<p>Those registration steps may be automated by an AWS Lambda rule
triggered by the certificate registration event, or by a local script,
such as:</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode numberSource bash numberLines"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="va">MY_POLICY</span><span class="op">=</span><span class="st">&quot;AllowAllDev&quot;</span></span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="va">CA_CERT_ID</span><span class="op">=</span><span class="st">&quot;xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx&quot;</span> <span class="co"># DUA User root CA certificate ID</span></span>
<span id="cb23-4"><a href="#cb23-4"></a></span>
<span id="cb23-5"><a href="#cb23-5"></a><span class="cf">case</span> <span class="st">&quot;</span><span class="va">$1</span><span class="st">&quot;</span> <span class="kw">in</span></span>
<span id="cb23-6"><a href="#cb23-6"></a>  <span class="st">&quot;provision&quot;</span><span class="kw">)</span></span>
<span id="cb23-7"><a href="#cb23-7"></a>    <span class="va">CERT_ID_LIST</span><span class="op">=</span><span class="va">$(</span><span class="ex">aws</span> iot list-certificates-by-ca <span class="at">--ca-certificate-id</span> <span class="va">$CA_CERT_ID</span> <span class="at">--query</span> <span class="st">&#39;certificates[?status==`PENDING_ACTIVATION`].certificateId|join(`, `, @)&#39;</span> <span class="kw">|</span> <span class="fu">tr</span> <span class="at">-d</span> <span class="st">&#39;,&quot;&#39;</span><span class="va">)</span></span>
<span id="cb23-8"><a href="#cb23-8"></a>    <span class="cf">for</span> CERT_ID <span class="kw">in</span> <span class="va">$CERT_ID_LIST</span><span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb23-9"><a href="#cb23-9"></a>      <span class="bu">echo</span> <span class="st">&quot;Lookup </span><span class="va">$CERT_ID</span><span class="st">&quot;</span></span>
<span id="cb23-10"><a href="#cb23-10"></a>      <span class="va">CERT_ARN</span><span class="op">=</span><span class="va">$(</span><span class="ex">aws</span> iot describe-certificate <span class="at">--certificate-id</span> <span class="va">$CERT_ID</span> <span class="at">--query</span> <span class="st">&#39;certificateDescription.certificateArn&#39;</span> <span class="kw">|</span> <span class="fu">tr</span> <span class="at">-d</span> <span class="st">&#39;&quot;&#39;</span><span class="va">)</span></span>
<span id="cb23-11"><a href="#cb23-11"></a>      <span class="va">CERT_PEM</span><span class="op">=</span><span class="va">$(</span><span class="ex">aws</span> iot describe-certificate <span class="at">--certificate-id</span> <span class="va">$CERT_ID</span> <span class="at">--query</span> <span class="st">&#39;certificateDescription.certificatePem&#39;</span><span class="va">)</span></span>
<span id="cb23-12"><a href="#cb23-12"></a>      <span class="va">THING_NAME</span><span class="op">=</span><span class="va">$(</span><span class="bu">echo</span> <span class="st">&quot;</span><span class="va">${CERT_PEM</span><span class="op">//</span><span class="st">&#39;\n&#39;</span><span class="op">/</span><span class="st">$&#39;</span><span class="dt">\n</span><span class="st">&#39;</span><span class="va">}</span><span class="st">&quot;</span> <span class="kw">|</span> <span class="fu">tr</span> <span class="at">-d</span> <span class="st">&#39;&quot;&#39;</span> <span class="kw">|</span> <span class="ex">openssl</span> x509 <span class="at">-noout</span> <span class="at">-subject</span> <span class="at">-nameopt</span> sep_multiline <span class="kw">|</span> <span class="fu">awk</span> <span class="at">-F</span><span class="op">=</span> <span class="st">&#39;/ *CN=/{ print $2 }&#39;</span><span class="va">)</span></span>
<span id="cb23-13"><a href="#cb23-13"></a>      <span class="bu">echo</span> <span class="st">&quot;Cert Arn: </span><span class="va">$CERT_ARN</span><span class="st">&quot;</span></span>
<span id="cb23-14"><a href="#cb23-14"></a>      <span class="bu">echo</span> <span class="st">&quot;Thing name: </span><span class="va">$THING_NAME</span><span class="st">&quot;</span></span>
<span id="cb23-15"><a href="#cb23-15"></a>      <span class="ex">aws</span> iot update-certificate <span class="at">--certificate-id</span> <span class="va">$CERT_ID</span> <span class="at">--new-status</span> <span class="st">&quot;ACTIVE&quot;</span></span>
<span id="cb23-16"><a href="#cb23-16"></a>      <span class="ex">aws</span> iot attach-policy <span class="at">--policy-name</span> <span class="st">&quot;</span><span class="va">$MY_POLICY</span><span class="st">&quot;</span> <span class="at">--target</span> <span class="st">&quot;</span><span class="va">$CERT_ARN</span><span class="st">&quot;</span></span>
<span id="cb23-17"><a href="#cb23-17"></a>      <span class="ex">aws</span> iot create-thing <span class="at">--thing-name</span> <span class="st">&quot;</span><span class="va">$THING_NAME</span><span class="st">&quot;</span></span>
<span id="cb23-18"><a href="#cb23-18"></a>      <span class="ex">aws</span> iot attach-thing-principal <span class="at">--thing-name</span> <span class="st">&quot;</span><span class="va">$THING_NAME</span><span class="st">&quot;</span> <span class="at">--principal</span> <span class="st">&quot;</span><span class="va">$CERT_ARN</span><span class="st">&quot;</span></span>
<span id="cb23-19"><a href="#cb23-19"></a>    <span class="cf">done</span></span>
<span id="cb23-20"><a href="#cb23-20"></a>    <span class="cf">;;</span></span>
<span id="cb23-21"><a href="#cb23-21"></a>  <span class="st">&quot;clear&quot;</span><span class="kw">)</span></span>
<span id="cb23-22"><a href="#cb23-22"></a>      <span class="va">CERT_ID_LIST</span><span class="op">=</span><span class="va">$(</span><span class="ex">aws</span> iot list-certificates-by-ca <span class="at">--ca-certificate-id</span> <span class="va">$CA_CERT_ID</span> <span class="at">--query</span> <span class="st">&#39;certificates[?status==`ACTIVE`].certificateId|join(`, `, @)&#39;</span> <span class="kw">|</span> <span class="fu">tr</span> <span class="at">-d</span> <span class="st">&#39;,&quot;&#39;</span><span class="va">)</span></span>
<span id="cb23-23"><a href="#cb23-23"></a>    <span class="cf">for</span> CERT_ID <span class="kw">in</span> <span class="va">$CERT_ID_LIST</span><span class="kw">;</span> <span class="cf">do</span></span>
<span id="cb23-24"><a href="#cb23-24"></a>      <span class="bu">echo</span> <span class="st">&quot;Lookup </span><span class="va">$CERT_ID</span><span class="st">&quot;</span></span>
<span id="cb23-25"><a href="#cb23-25"></a>      <span class="va">CERT_ARN</span><span class="op">=</span><span class="va">$(</span><span class="ex">aws</span> iot describe-certificate <span class="at">--certificate-id</span> <span class="va">$CERT_ID</span> <span class="at">--query</span> <span class="st">&#39;certificateDescription.certificateArn&#39;</span> <span class="kw">|</span> <span class="fu">tr</span> <span class="at">-d</span> <span class="st">&#39;&quot;&#39;</span><span class="va">)</span></span>
<span id="cb23-26"><a href="#cb23-26"></a>      <span class="va">CERT_PEM</span><span class="op">=</span><span class="va">$(</span><span class="ex">aws</span> iot describe-certificate <span class="at">--certificate-id</span> <span class="va">$CERT_ID</span> <span class="at">--query</span> <span class="st">&#39;certificateDescription.certificatePem&#39;</span><span class="va">)</span></span>
<span id="cb23-27"><a href="#cb23-27"></a>      <span class="va">THING_NAME</span><span class="op">=</span><span class="va">$(</span><span class="bu">echo</span> <span class="st">&quot;</span><span class="va">${CERT_PEM</span><span class="op">//</span><span class="st">&#39;\n&#39;</span><span class="op">/</span><span class="st">$&#39;</span><span class="dt">\n</span><span class="st">&#39;</span><span class="va">}</span><span class="st">&quot;</span> <span class="kw">|</span> <span class="fu">tr</span> <span class="at">-d</span> <span class="st">&#39;&quot;&#39;</span> <span class="kw">|</span> <span class="ex">openssl</span> x509 <span class="at">-noout</span> <span class="at">-subject</span> <span class="at">-nameopt</span> sep_multiline <span class="kw">|</span> <span class="fu">awk</span> <span class="at">-F</span><span class="op">=</span> <span class="st">&#39;/ *CN=/{ print $2 }&#39;</span><span class="va">)</span></span>
<span id="cb23-28"><a href="#cb23-28"></a>      <span class="bu">echo</span> <span class="st">&quot;Cert Arn: </span><span class="va">$CERT_ARN</span><span class="st">&quot;</span></span>
<span id="cb23-29"><a href="#cb23-29"></a>      <span class="bu">echo</span> <span class="st">&quot;Thing name: </span><span class="va">$THING_NAME</span><span class="st">&quot;</span></span>
<span id="cb23-30"><a href="#cb23-30"></a>      <span class="ex">aws</span> iot detach-policy <span class="at">--policy-name</span> <span class="st">&quot;</span><span class="va">$MY_POLICY</span><span class="st">&quot;</span> <span class="at">--target</span> <span class="st">&quot;</span><span class="va">$CERT_ARN</span><span class="st">&quot;</span></span>
<span id="cb23-31"><a href="#cb23-31"></a>      <span class="ex">aws</span> iot update-certificate <span class="at">--certificate-id</span> <span class="st">&quot;</span><span class="va">$CERT_ID</span><span class="st">&quot;</span> <span class="at">--new-status</span> <span class="st">&quot;INACTIVE&quot;</span></span>
<span id="cb23-32"><a href="#cb23-32"></a>      <span class="ex">aws</span> iot detach-thing-principal <span class="at">--thing-name</span> <span class="st">&quot;</span><span class="va">$THING_NAME</span><span class="st">&quot;</span> <span class="at">--principal</span> <span class="st">&quot;</span><span class="va">$CERT_ARN</span><span class="st">&quot;</span></span>
<span id="cb23-33"><a href="#cb23-33"></a>      <span class="fu">sleep</span> 5 <span class="co"># Wait that the decommissioning is effective</span></span>
<span id="cb23-34"><a href="#cb23-34"></a>      <span class="ex">aws</span> iot delete-thing <span class="at">--thing-name</span> <span class="st">&quot;</span><span class="va">$THING_NAME</span><span class="st">&quot;</span></span>
<span id="cb23-35"><a href="#cb23-35"></a>      <span class="ex">aws</span> iot delete-certificate <span class="at">--certificate-id</span> <span class="st">&quot;</span><span class="va">$CERT_ID</span><span class="st">&quot;</span></span>
<span id="cb23-36"><a href="#cb23-36"></a>    <span class="cf">done</span></span>
<span id="cb23-37"><a href="#cb23-37"></a>    <span class="cf">;;</span></span>
<span id="cb23-38"><a href="#cb23-38"></a>  <span class="pp">*</span><span class="kw">)</span></span>
<span id="cb23-39"><a href="#cb23-39"></a>    <span class="bu">echo</span> <span class="st">&quot;Error: No valid command argument was specified: &#39;</span><span class="va">$1</span><span class="st">&#39;&quot;</span></span>
<span id="cb23-40"><a href="#cb23-40"></a>    <span class="bu">echo</span> <span class="st">&quot;Syntax: </span><span class="va">$0</span><span class="st"> {provision|clear}&quot;</span></span>
<span id="cb23-41"><a href="#cb23-41"></a>    <span class="cf">;;</span></span>
<span id="cb23-42"><a href="#cb23-42"></a><span class="cf">esac</span></span></code></pre></div>
<h2 data-number="4.4"
id="observation-of-mqtt-messages-on-the-aws-iot-core-console"><span
class="header-section-number">4.4</span> Observation of MQTT messages on
the AWS IoT Core Console</h2>
<ol type="1">
<li>Log in to <a
href="https://aws.amazon.com">https://aws.amazon.com</a> with your IAM
User.</li>
<li>Navigate to the <em>Iot Core</em> service using the search box at
the top of the page.</li>
<li>Select the AWS region where your endpoint is located using the
select button at the top-right of the page.</li>
<li>Using the menu on the left side of the screen, select
<strong>Test</strong>/<strong>MQTT test client</strong></li>
<li>Set the topic filter to <em>#</em> and click the <em>Subscribe</em>
button.</li>
</ol>
<p>You will soon see telemetry data streaming from your device.</p>
<h2 data-number="4.5" id="ota-firmware-update"><span
class="header-section-number">4.5</span> OTA Firmware Update</h2>
<p>Overview:</p>
<ul>
<li><p>The application example runs a FreeRTOS OTA agent as one of the
RTOS tasks, which waits for OTA update jobs from the FreeRTOS
OTA Service running in AWS.</p></li>
<li><p>The update file is streamed over MQTT.</p></li>
<li><p>After download, the application verifies its authenticity thanks
to a code signing public key and to the signature embedded in the OTA
update job document. This forms an application-level file integrity and
authentication check, which is supplemented by the Secure Manager secure
firmware update feature (which relies, by contrast, on the image header
set at post-build time).</p></li>
</ul>
<p>Before being able to create a FreeRTOS OTA Update job, you must
create a code signing profile.</p>
<h3 data-number="4.5.1" id="generate-a-code-signing-key"><span
class="header-section-number">4.5.1</span> Generate a code signing
key</h3>
<p>Setup and provision the code signing credentials so as to enable the
FreeRTOS OTA Update Service to digitally sign the image file and the
device to verify the image file signature before installation.</p>
<ol type="1">
<li><p>In your working directory, use the following text to create a
file named <code>cert_config.txt</code>. Replace
<em>test_signer@amazon.com</em> with your email address:</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode ini"><code class="sourceCode ini"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[ req ]</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="dt">prompt             </span><span class="ot">=</span><span class="st"> </span><span class="kw">no</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="dt">distinguished_name </span><span class="ot">=</span><span class="st"> my_dn</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="kw">[ my_dn ]</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="dt">commonName </span><span class="ot">=</span><span class="st"> test_signer@amazon.com</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="kw">[ my_exts ]</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="dt">keyUsage         </span><span class="ot">=</span><span class="st"> digitalSignature</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="dt">extendedKeyUsage </span><span class="ot">=</span><span class="st"> codeSigning</span></span></code></pre></div></li>
<li><p>Create an ECDSA code-signing private key:</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="ex">openssl</span> genpkey <span class="at">-algorithm</span> EC <span class="dt">\</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">-pkeyopt</span> ec_paramgen_curve:P-256 <span class="dt">\</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">-pkeyopt</span> ec_param_enc:named_curve <span class="dt">\</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">-outform</span> PEM <span class="dt">\</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">-out</span> ecdsasigner-priv-key.pem</span></code></pre></div></li>
<li><p>Generate the corresponding public key from the private key:</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="ex">openssl</span> ec <span class="at">-inform</span> PEM <span class="dt">\</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">-in</span> ecdsasigner-priv-key.pem <span class="dt">\</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">-pubout</span> <span class="dt">\</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">-outform</span> PEM <span class="dt">\</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">-out</span> ecdsasigner-pub-key.pem</span></code></pre></div></li>
<li><p>Create an ECDSA code-signing certificate to be uploaded to the
AWS Certificate Manager service (ACM):</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="ex">openssl</span> req <span class="at">-new</span> <span class="at">-x509</span> <span class="dt">\</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">-config</span> cert_config.txt <span class="dt">\</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">-extensions</span> my_exts <span class="dt">\</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">-nodes</span> <span class="dt">\</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">-days</span> 365 <span class="dt">\</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">-key</span> ecdsasigner-priv-key.pem <span class="dt">\</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">-out</span> ecdsasigner.crt</span></code></pre></div></li>
<li><p>Import the code-signing certificate and private key into ACM:</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> acm import-certificate <span class="at">--certificate</span> fileb://ecdsasigner.crt <span class="dt">\</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">--private-key</span> fileb://ecdsasigner-priv-key.pem</span></code></pre></div>
<p>Note down the ARN of the code signing certificate. It will be
referred to as <em>&lt;code_sign_cert_arn&gt;</em> when creating the
code signing profile below.</p></li>
<li><p>If not already done, connect to the target device via a serial
terminal.</p>
<p>Copy/paste the contents of the <em>ecdsasigner-pub-key.pem</em> file
on the terminal right after this command, and type <em>enter</em>:</p>
<pre><code>&gt; pki import key ota_signer_pub
-----BEGIN PUBLIC KEY-----
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
-----END PUBLIC KEY-----</code></pre>
<p>Note: <em>ota_signer_pub</em> is the label used to refer to the code
signing key during verification of the firmware update.</p></li>
<li><p>Create a signing profile in AWS to sign the firmware images.</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> signer put-signing-profile <span class="at">--profile-name</span> <span class="op">&lt;</span>your profile name<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">--signing-material</span> certificateArn=<span class="op">&lt;</span>code_sign_cert_arn<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">--platform</span> AmazonFreeRTOS-Default <span class="dt">\</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">--signing-parameters</span> certname=ota_signer_pub</span></code></pre></div>
<p>Summary of the generated files:</p>
<table>
<caption>Table: Code signing profile intermediate files</caption>
<thead>
<tr class="header">
<th style="text-align: left;">File name</th>
<th style="text-align: left;">Contents</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">ecdsasigner-priv-key.pem</td>
<td style="text-align: left;">Code signing private key</td>
</tr>
<tr class="even">
<td style="text-align: left;">ecdsasigner-pub-key.pem</td>
<td style="text-align: left;">Code signing public key</td>
</tr>
<tr class="odd">
<td style="text-align: left;">cert_config.txt</td>
<td style="text-align: left;">Code signing certificate signature request
parameters</td>
</tr>
<tr class="even">
<td style="text-align: left;">ecdsasigner.crt</td>
<td style="text-align: left;">Code signing certificate</td>
</tr>
</tbody>
</table></li>
</ol>
<h3 data-number="4.5.2"
id="setup-ota-s3-bucket-service-role-and-policies-in-aws"><span
class="header-section-number">4.5.2</span> Setup OTA S3 bucket, Service
role and policies in AWS</h3>
<ol type="1">
<li><p>Create an S3 bucket to store the new firmware image to be
updated:<br />
<a
href="https://docs.aws.amazon.com/freertos/latest/userguide/dg-ota-bucket.html">https://docs.aws.amazon.com/freertos/latest/userguide/dg-ota-bucket.html</a></p>
<p>In the next steps, the name of this bucket is referred to as
<em><s3 bucket for image></em>.</p></li>
</ol>
<blockquote>
<p><mark>Important</mark> <strong>In case of OTA update of the Secure
Manager image</strong>.<br />
It is the user responsibility to satisty to the export control
regulations.<br />
Before uploading any Secure Manager image to AWS S3 or to any other
entity, ensure that the files added to the bucket may not leak or bypass
the export control.</p>
</blockquote>
<ol start="2" type="1">
<li><p>Create a service role which grants permission for OTA service to
access the firmware image:<br />
<a
href="https://docs.aws.amazon.com/freertos/latest/userguide/create-service-role.html">https://docs.aws.amazon.com/freertos/latest/userguide/create-service-role.html</a></p></li>
<li><p>Create an OTA update policy:<br />
<a
href="https://docs.aws.amazon.com/freertos/latest/userguide/create-ota-user-policy.html">https://docs.aws.amazon.com/freertos/latest/userguide/create-ota-user-policy.html</a></p></li>
<li><p>Add a policy for AWS IoT to access the code signing
profile:<br />
<a
href="https://docs.aws.amazon.com/freertos/latest/userguide/code-sign-policy.html">https://docs.aws.amazon.com/freertos/latest/userguide/code-sign-policy.html</a></p></li>
</ol>
<h3 data-number="4.5.3"
id="create-a-code-signed-firmware-update-job"><span
class="header-section-number">4.5.3</span> Create a code signed firmware
update job</h3>
<ol type="1">
<li><p>Bump up the version of the new firmware image of the application
to be updated.</p>
<ol type="a">
<li><p>Open the file
<em>&lt;project&gt;/Images/SM_Code_Image_bin.xml</em></p></li>
<li><p>Increment the <em>Version.Value</em> parameter:</p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode diff"><code class="sourceCode diff"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>     &lt;Param&gt;</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>       &lt;Name&gt;Version&lt;/Name&gt;</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="st">-      &lt;Value&gt;1.0.0&lt;/Value&gt;</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="va">+      &lt;Value&gt;1.1.0&lt;/Value&gt;</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>       &lt;Type&gt;Data&lt;/Type&gt;</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>       &lt;Command&gt;-v&lt;/Command&gt;</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>       &lt;Tooltip&gt;Version of the data binary. Format is x.y.z&lt;/Tooltip&gt;</span></code></pre></div></li>
<li><p>Re-build the application, so that the post-build script sets the
new version in the image header.</p></li>
</ol>
<p><mark>Warning</mark>: If the image self-test procedure embedded in
the application does not detect a higher version number after
installation, the self-test procedure fails, the update is reverted, and
the OTA job is reported as rejected.</p></li>
<li><p>Upload the new image file to the S3 bucket created in the
previous section.</p>
<p>The application image file generated by the post-build script is
created as <em>&lt;project&gt;/Binaries/appli_enc_sign.bin</em>.</p>
<p>In the following commands, <em>&lt;image binary path&gt;</em> is
<em>&lt;project&gt;/Binaries/appli_enc_sign.bin</em>, and <em>&lt;image
binary name&gt;</em> is <em>appli_enc_sign.bin</em>.</p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> s3 cp <span class="op">&lt;</span>image_binary_path<span class="op">&gt;</span> s3://<span class="op">&lt;</span>s3_bucket_for_image<span class="op">&gt;</span>/</span></code></pre></div></li>
<li><p>Get the latest S3 file version of the binary image:</p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> s3api  list-object-versions <span class="at">--bucket</span> <span class="op">&lt;</span>s3_bucket_for_image<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">--prefix</span> <span class="op">&lt;</span>image_binary_name<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>      <span class="at">--query</span> <span class="st">&#39;Versions[?IsLatest==`true`]&#39;</span></span></code></pre></div></li>
<li><p>Create a new OTA Update job configuration json file (Example:
<em>ota-update-job-config.json</em>) on your computer as below.</p>
<p>Substitute the parameters with the output obtained from steps
above.</p>
<p>An OTA job may update either the non-secure image partition (which
contains the user application), or the secure image partition (which
contains the Secure Manager).</p>
<p>The image to update must be specified in the
<em>files[].fileName</em> field of the
<em>ota-update-job-config.json</em> file: <em>“non_secure image”</em>,
or <em>“secure image”</em> for the OTA Agent to identify the image
properly. Otherwise no image is downloaded.</p>
<p>The <em>files[].fileLocation.s3Location.key</em> field should then be
set to <em>appli_enc_sign.bin</em> or <em>&lt;SecurityManager bin
filename&gt;</em>, respectively.</p>
<p>The example below specifies an OTA firmware update of the non-secure
partition, within a TrustZone-enabled application:</p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;otaUpdateId&quot;</span><span class="fu">:</span> <span class="st">&quot;&lt;ota_update_unique_identifier&gt;&quot;</span><span class="fu">,</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;targets&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>      <span class="st">&quot;arn:aws:iot:&lt;region&gt;:&lt;account_id&gt;:thing/&lt;thing_name&gt;&quot;</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;targetSelection&quot;</span><span class="fu">:</span> <span class="st">&quot;SNAPSHOT&quot;</span><span class="fu">,</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;files&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="fu">{</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;fileName&quot;</span><span class="fu">:</span> <span class="st">&quot;non_secure image&quot;</span><span class="fu">,</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;fileVersion&quot;</span><span class="fu">:</span> <span class="st">&quot;1&quot;</span><span class="fu">,</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;fileLocation&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;s3Location&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>              <span class="dt">&quot;bucket&quot;</span><span class="fu">:</span> <span class="st">&quot;&lt;s3_bucket_for_image&gt;&quot;</span><span class="fu">,</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>              <span class="dt">&quot;key&quot;</span><span class="fu">:</span> <span class="st">&quot;appli_enc_sign.bin&quot;</span><span class="fu">,</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>              <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="st">&quot;&lt;latest_s3_file_version_of_binary_image&gt;&quot;</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>          <span class="fu">}</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>      <span class="fu">},</span></span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>      <span class="dt">&quot;codeSigning&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>          <span class="dt">&quot;startSigningJobParameter&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>              <span class="dt">&quot;signingProfileName&quot;</span><span class="fu">:</span> <span class="st">&quot;&lt;signing_profile_name&gt;&quot;</span><span class="fu">,</span></span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>              <span class="dt">&quot;destination&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>                  <span class="dt">&quot;s3Destination&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>                      <span class="dt">&quot;bucket&quot;</span><span class="fu">:</span> <span class="st">&quot;&lt;s3_bucket_for_image&gt;&quot;</span></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>                  <span class="fu">}</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>              <span class="fu">}</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>          <span class="fu">}</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;roleArn&quot;</span><span class="fu">:</span> <span class="st">&quot;arn:aws:iam::&lt;account_id&gt;:role/&lt;OTA_service_role&gt;&quot;</span></span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><mark>Important</mark> Please check the <mark>X-CUBE-SEC-M-H5</mark>
Release Notes for the availability of the <em>SecurityManager
binary</em> file and the image dependency management.</p></li>
<li><p>Create a new OTA update job from the configuration file:</p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> iot create-ota-update <span class="at">--cli-input-json</span> file://ota-update-job-config.json</span></code></pre></div>
<p>The command above must be launched from the folder containing the
<em>ota-update-job-config.json</em> file.</p>
<p>On success, the command returns the OTA Update identifier (referred
to as <em>&lt;ota_update_identifier&gt;</em> in the next step) and
status of the job as <em>CREATE_PENDING</em>.</p>
<p>At user convenience, and as an alternative to a local JSON file for
creating an OTA update job with a unique update ID, a scripted command
line may also be used, such as:</p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode numberSource bash numberLines"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb36-2"><a href="#cb36-2"></a><span class="va">UPDATE_ID</span><span class="op">=</span><span class="st">&quot;H5DK_</span><span class="va">$(</span><span class="fu">date</span> +%F_%H%M<span class="va">)</span><span class="st">&quot;</span></span>
<span id="cb36-3"><a href="#cb36-3"></a><span class="va">TARGETS</span><span class="op">=</span><span class="st">&quot;arn:aws:iot:&lt;region&gt;:&lt;account_id&gt;:thing/&lt;thing_name&gt;&quot;</span></span>
<span id="cb36-4"><a href="#cb36-4"></a><span class="va">ROLE_ARN</span><span class="op">=</span><span class="st">&quot;arn:aws:iam::&lt;account_id&gt;:role/&lt;OTA_service_role&gt;&quot;</span></span>
<span id="cb36-5"><a href="#cb36-5"></a><span class="va">fileName</span><span class="op">=</span><span class="st">&quot;non_secure image&quot;</span></span>
<span id="cb36-6"><a href="#cb36-6"></a><span class="va">otaBucketName</span><span class="op">=</span><span class="st">&quot;&lt;s3_bucket_for_image&gt;&quot;</span></span>
<span id="cb36-7"><a href="#cb36-7"></a><span class="va">fileKey</span><span class="op">=</span><span class="st">&quot;appli_enc_sign.bin&quot;</span></span>
<span id="cb36-8"><a href="#cb36-8"></a><span class="va">fileVersion</span><span class="op">=</span><span class="st">&quot;&lt;latest_s3_file_version_of_binary_image&gt;&quot;</span></span>
<span id="cb36-9"><a href="#cb36-9"></a><span class="va">otaCodeSigningProfile</span><span class="op">=</span><span class="st">&quot;&lt;signing_profile_name&gt;&quot;</span></span>
<span id="cb36-10"><a href="#cb36-10"></a></span>
<span id="cb36-11"><a href="#cb36-11"></a><span class="va">FILES</span><span class="op">=</span><span class="st">&quot;fileName=</span><span class="va">$fileName</span><span class="st">,</span><span class="dt">\</span></span>
<span id="cb36-12"><a href="#cb36-12"></a><span class="st">       fileLocation={s3Location={bucket=</span><span class="va">$otaBucketName</span><span class="st">,key=</span><span class="va">$fileKey</span><span class="st">,version=</span><span class="va">$fileVersion</span><span class="st">}},</span><span class="dt">\</span></span>
<span id="cb36-13"><a href="#cb36-13"></a><span class="st">       codeSigning={startSigningJobParameter={signingProfileName=</span><span class="dt">\</span></span>
<span id="cb36-14"><a href="#cb36-14"></a><span class="st">         </span><span class="va">$otaCodeSigningProfile</span><span class="st">,</span><span class="dt">\</span></span>
<span id="cb36-15"><a href="#cb36-15"></a><span class="st">         destination={s3Destination={bucket=</span><span class="va">$otaBucketName</span><span class="st">}}}}&quot;</span></span>
<span id="cb36-16"><a href="#cb36-16"></a></span>
<span id="cb36-17"><a href="#cb36-17"></a><span class="ex">aws</span> iot create-ota-update <span class="at">--ota-update-id</span> <span class="st">&quot;</span><span class="va">$UPDATE_ID</span><span class="st">&quot;</span> <span class="dt">\</span></span>
<span id="cb36-18"><a href="#cb36-18"></a>      <span class="at">--targets</span> <span class="st">&quot;</span><span class="va">$TARGETS</span><span class="st">&quot;</span> <span class="dt">\</span></span>
<span id="cb36-19"><a href="#cb36-19"></a>      <span class="at">--target-selection</span> <span class="st">&quot;SNAPSHOT&quot;</span> <span class="dt">\</span></span>
<span id="cb36-20"><a href="#cb36-20"></a>      <span class="at">--files</span> <span class="st">&quot;</span><span class="va">$FILES</span><span class="st">&quot;</span> <span class="dt">\</span></span>
<span id="cb36-21"><a href="#cb36-21"></a>      <span class="at">--role-arn</span> <span class="st">&quot;</span><span class="va">$ROLE_ARN</span><span class="st">&quot;</span></span></code></pre></div></li>
<li><p>To get the corresponding job ID, execute the following command
and look for <em>awsIotJobId</em> field in json document returned.</p>
<div class="sourceCode" id="cb37"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> iot get-ota-update <span class="at">--ota-update-id</span><span class="op">=&lt;</span>ota_update_identifier<span class="op">&gt;</span></span></code></pre></div>
<p>Note down the job ID to check the status of the job later.</p></li>
</ol>
<h3 data-number="4.5.4"
id="monitoring-and-verification-of-firmware-update"><span
class="header-section-number">4.5.4</span> Monitoring and Verification
of firmware update</h3>
<ol type="1">
<li><p>Once the OTA job is created, the job document is sent by AWS to
the device, and your serial terminal emulator logs show that OTA job is
accepted. The device subsequently starts downloading image.</p>
<pre><code>&lt;INF&gt;   247960 [MQTTAgent ] Received OTA job message, size: 508. (ota_update_task.c:921)
&lt;INF&gt;   247961 [OTAAgent  ] Extracted parameter: [key: value]=[execution.jobId: AFR_OTA-H5DK_2023-08-03_1507] (ota.c:1678)
&lt;INF&gt;   247962 [OTAAgent  ] Extracted parameter: [key: value]=[execution.jobDocument.afr_ota.streamname: AFR_OTA-42402af7-43b0-4ab9-acd1-3de90c1f4fa1] (ota.c:1678)
&lt;INF&gt;   247962 [OTAAgent  ] Extracted parameter: [key: value]=[execution.jobDocument.afr_ota.protocols: [&quot;MQTT&quot;]] (ota.c:1678)
&lt;INF&gt;   247963 [OTAAgent  ] Extracted parameter: [key: value]=[filepath: non_secure image] (ota.c:1678)
&lt;INF&gt;   247963 [OTAAgent  ] Extracted parameter: [key: value]=[filesize: 398850] (ota.c:1719)
&lt;INF&gt;   247963 [OTAAgent  ] Extracted parameter: [key: value]=[fileid: 0] (ota.c:1719)
&lt;INF&gt;   247963 [OTAAgent  ] Extracted parameter: [key: value]=[certfile: ota_signer_pub] (ota.c:1678)
&lt;INF&gt;   247964 [OTAAgent  ] Extracted parameter [ sig-sha256-ecdsa: MEUCIQDj5LYF7goIjpeTIfLNEc0K6/+9... ] (ota.c:1609)
&lt;INF&gt;   247964 [OTAAgent  ] Job document was accepted. Attempting to begin the update. (ota.c:2258)</code></pre></li>
<li><p>Once the full image has been downloaded, the OTA library verifies
the image signature and requests the image installation by PSA Firmware
Update.</p>
<pre><code>&lt;INF&gt;   265821 [OTAAgent  ] Received final block of the update. (ota.c:2718)
&lt;INF&gt;   266349 [OTAAgent  ] Received entire update and validated the signature. (ota.c:2742)</code></pre></li>
<li><p>New image boots up and performs a self-test, here it checks the
version is higher than previous. If so it sets the new image as
valid.</p>
<pre><code>&lt;INF&gt;    10103 [OTAAgent  ] Beginning self-test. (ota.c:807)
&lt;INF&gt;    10104 [OTAAgent  ] Received OtaJobEventStartTest callback from OTA Agent. (ota_update_task.c:767)
&lt;INF&gt;    10363 [OTAAgent  ] PSA Image type 1 version validation succeeded, old version: 1.0.0 new version: 1.1.0 (ota_update_task.c:645)</code></pre></li>
<li><p>Checking the job status, should show the job as succeeded:</p>
<div class="sourceCode" id="cb41"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="ex">aws</span> iot describe-job-execution <span class="at">--job-id</span><span class="op">=&lt;</span>Job ID created above<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>      <span class="at">--thing-name</span><span class="op">=&lt;</span>thing name<span class="op">&gt;</span></span></code></pre></div></li>
</ol>
<h1 data-number="5" id="design-notes"><span
class="header-section-number">5</span> Design notes</h1>
<h2 data-number="5.1"
id="shared-resources-between-the-non-secure-partition-and-the-secure-partition"><span
class="header-section-number">5.1</span> Shared resources between the
non-secure partition and the secure partition</h2>
<h3 data-number="5.1.1" id="clocks"><span
class="header-section-number">5.1.1</span> Clocks</h3>
<p>The clocks of the RNG IP are configured at application startup, so
that the Secure Manager services may use the IP without interfering with
the settings of the non-secure user application.</p>
<h3 data-number="5.1.2" id="stlink-uart"><span
class="header-section-number">5.1.2</span> STLINK UART</h3>
<p>This UART is used concurrenlty</p>
<ul>
<li>by the embedded command line interface running in the non-secure
partition</li>
<li>by the Secure Manager logging utility running in the secure
partition</li>
</ul>
<p>The UART settings configured by the application are compatible with
the usage by the secure partition.</p>
<h2 data-number="5.2" id="freertos-heap-configuration"><span
class="header-section-number">5.2</span> FreeRTOS heap
configuration</h2>
<p>The <em>heap_5</em> implementation of FreeRTOS dynamic memory
allocator is selected to use non-contiguous memory regions in SRAM1 and
SRAM3.</p>
<p>They are set in <em>app_main.c::prvInitializeHeap()</em>.</p>
<p>Note that the FreeRTOS <code>configTOTAL_HEAP_SIZE</code> definition
specifies the overall size, while <code>SRAM3_NS_SIZE</code> specifies
how much of the non-secure part of SRAM3 is to be used by the FreeRTOS
heap.</p>
<h2 data-number="5.3" id="mbedtls-configuration"><span
class="header-section-number">5.3</span> MbedTLS configuration</h2>
<p>The MbedTLS configuration file
<em>&lt;project&gt;/Inc/mbedtls_config_psa.h</em> is tuned to reduce the
read-only memory footprint.</p>
<p>In particular the support of RSA-based cipher suites is disabled.
Therefore, the root CA certificate provisioned for authenticating the
endpoint must be based on an ECDSA key. That is the <em>Amazon Root CA
3</em> CA which is specified in the provisioning section above.</p>
<p>In case there is a TLS error during the handshake, ensure that the
proper certificate was provisionned. Its common name is displayed on the
console as follows:</p>
<pre><code>&lt;INF&gt;      916 [MQTTAgent ] CA Certificate:  CN=Amazon Root CA 3, SN:0x066C9FD5749736663F3B0B9AD9E89E7603F24A (mbedtls_transport.c:335)</code></pre>
<h2 data-number="5.4" id="ethernet-mac-address-definition"><span
class="header-section-number">5.4</span> Ethernet MAC address
definition</h2>
<ul>
<li><p>The application example derives the MAC address from the
MCU device ID, and configures the Ethernet hardware IP.</p></li>
<li><p>On STM32H5, the MCU device ID is mapped in a region of the system
flash which does not support cached accesses. The application init
therefore configures the MPU so that this region is mapped as
non-cacheable device memory.</p></li>
</ul>
<h2 data-number="5.5"
id="provisions-for-running-freertos-qualification-tests"><span
class="header-section-number">5.5</span> Provisions for running FreeRTOS
qualification tests</h2>
<ul>
<li>The <em>FreeRTOS-Libraries-Integration-Tests</em> module is included
in the project, together with the needed application and configurarion
files.</li>
<li>The test task is built and replaces the reference integration
applicative tasks only if one test case is selected in the configuration
file
<em><env_dir>/Projects/Common/config/test_execution_config.h</em>.</li>
<li>The qualification testing status is documented in the release
notes.</li>
</ul>
<h2 data-number="5.6" id="ide-project-settings"><span
class="header-section-number">5.6</span> IDE project settings</h2>
<ul>
<li>Included links to useful files in the Project Explorer pane
<ul>
<li><em>download.bat</em>, for programming the target after build (only
on MS Windows)</li>
<li><em>prebuild.log</em>, <em>postbuild.log</em>,
<em>download.log</em>, for quicker access and script
troubleshooting</li>
</ul></li>
<li>Build settings
<ul>
<li>Only the <em>Debug</em> target is provided</li>
<li>Added Secure Manager integration pre-build and post-build
commands</li>
<li>Enabled .bin in MCU Post build outputs: <code>-O binary</code></li>
<li>Selected debug-compatible compiler optimization:
<code>-Og -g3</code></li>
<li>Selected target-specific compiler optimization: <em>assume loading
data from flash is slower than fetching instructions</em>
<code>-mslow-flash-data</code></li>
<li>No float support in printf</li>
</ul></li>
<li>Debug launcher settings
<ul>
<li><p>No download and image verification.<br />
It is handled by the download script.</p></li>
<li><p>Connect without reset<br />
The debugger is not allowed to attach right after target reset, when the
MCU is running in the secure partition in TZ-CLOSE mode. So the debugger
must be attached at non-secure runtime.<br />
In order to debug the application startup, the user must first start a
debug session, then reset the board manually by pushing the reset
button. The CPU then breaks on the application entry point, and the
non-secure code can be debugged normally.<br />
Note that it is not possible to step into the secure code: The debugger
will immediately loose the connection to the MCU.</p></li>
<li><p>Enable FreeRTOS awareness for Cortex-M33 NTZ (the FreeRTOS kernel
fully runs in the non-secure partition)</p></li>
<li><p>The following script is added to the <strong>Startup</strong>
tab/<strong>Run Commands</strong> text area, in order to allow the IDE
to directly program the user application in the non-secure
partition.<br />
Note however that this programming method bypasses the update of the
image header. Since the latter contains the image version and validation
state, this method is not compatible with OTA Update use cases, and will
in particular prevent the automatic rollback of the image version in
case of self-test failure. It is therefore not recommended, and not
enabled by default.</p>
<pre><code>set breakpoint always-inserted on
tbreak Reset_Handler
monitor reset
set breakpoint always-inserted off
si</code></pre></li>
</ul></li>
</ul>
<h1 data-number="6" id="troubleshooting"><span
class="header-section-number">6</span> Troubleshooting</h1>
<h2 data-number="6.1" id="windows-environment"><span
class="header-section-number">6.1</span> Windows environment</h2>
<h3 data-number="6.1.1" id="device-provisioning"><span
class="header-section-number">6.1.1</span> Device provisioning</h3>
<p>The <em>aws-cli</em> sample commands and scripts documented in the
readme are compatible with the <em>git-bash</em> shell.</p>
<ul>
<li><em>cmd.com</em> fails at parsing some query arguments of the JITR
registration script.</li>
<li><em>Powershell</em> does not recognize the <code>\</code> line
ending escape char.</li>
</ul>
<h3 data-number="6.1.2"
id="secure-manager-access-kit-scripts-for-trustzone-applications-sensitivity-to-the-path-environment-variable"><span
class="header-section-number">6.1.2</span> <em>Secure Manager Access
Kit</em> scripts for TrustZone applications: Sensitivity to the
<em>PATH</em> environment variable</h3>
<p><em>.bat</em> batch files and <em>.sh</em> bash files are
provided.</p>
<ul>
<li><em>.bat</em> files are expected to be called by double-clicking on
the file in Windows Explorer.
<ul>
<li>Trying to call <em>.bat</em> files from a Unix-like shell may fail
if some unix utilities have the precedence over the Windows utilities
(e.g. the <em>sleep</em> command does not supports the same arguments on
Windows and Unix).</li>
</ul></li>
<li><em>.sh</em> files are expected to be called by the STM32CubeIDE
projects pre- and post-build commands.<br />
They are sensitive to the environment where STM32CubeIDE is started.
<ul>
<li>Trying to launch STM32CubeIDE from a <em>git-bash</em> shell, all
the more if the shell interpreter runs in an external terminal emulator
such as Windows Terminal, may result in pre-build errors.</li>
</ul></li>
<li><em>provisioning.sh</em> and <em>regression.sh</em> may work or not,
depending on their launch environment (<em>PATH</em>, kind of shell,
terminal emulator). In case of issue, their <em>.bat</em> counterpart
should be used.</li>
</ul>
</body>
</html>
